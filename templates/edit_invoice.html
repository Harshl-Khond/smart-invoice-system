<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Invoice</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        *, *::before, *::after { box-sizing: border-box; }
        html { font-family: 'Inter', sans-serif; }

        :root {
            --color-primary-dark: #004d40;
            --color-primary-light: #00695c;
            --color-secondary-accent: #ffb300;
            --color-background-light: #f5f5f5;
        }

        body {
            background-color: var(--color-background-light);
            background-image: linear-gradient(180deg, #f5f5f5 50%, #eceff1 100%);
            min-height: 100vh;
            padding: 1.5rem;
        }

        .unique-card {
            background-color: white;
            border-top: 5px solid var(--color-primary-dark);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header-accent { color: var(--color-primary-dark); }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
        }

        .form-input:focus, .form-textarea:focus {
            border-color: var(--color-primary-light);
            box-shadow: 0 0 0 3px rgba(0,77,64,0.2);
        }

        .table-header { background-color: var(--color-primary-dark); }
        .btn-accent {
            background-color: var(--color-secondary-accent);
            color: var(--color-primary-dark);
            font-weight: 600;
        }
    </style>
</head>

<body>

<div class="container max-w-6xl mx-auto space-y-8">

    <div class="text-center unique-card p-6">
        <h1 class="text-3xl font-extrabold header-accent mb-2">Edit Invoice ‚úèÔ∏è</h1>
    </div>

    <form method="POST" action="{{ url_for('edit_invoice', doc_id=doc_id) }}" class="space-y-6">

        <!-- ========================== TOP SECTION ========================== -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- Invoice Details -->
            <div class="unique-card p-6 space-y-4">
                <h2 class="text-xl font-semibold header-accent border-b pb-2">Invoice Details</h2>

                <label class="text-sm font-medium">Invoice No</label>
                <input type="text" name="invoice_no" value="{{ invoice['invoice_no'] }}" readonly class="form-input bg-gray-50 font-bold">

                <label class="text-sm font-medium">Invoice Date</label>
                <input type="date" name="invoice_date" value="{{ invoice['invoice_date'] }}" class="form-input" required>

                <label class="text-sm font-medium">Due Date</label>
                <input type="date" name="due_date" value="{{ invoice['due_date'] }}" class="form-input" required>
            </div>

            <!-- Client Info -->
            <div class="unique-card p-6 space-y-4 md:col-span-2">
                <h2 class="text-xl font-semibold header-accent border-b pb-2">Client Information</h2>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

                    <input type="text"
                           name="client_name"
                           value="{{ invoice['client_name'] }}"
                           placeholder="Client Name"
                           class="form-input">

                    <input type="email"
                           name="client_email"
                           value="{{ invoice['client_email'] }}"
                           placeholder="Client Email"
                           class="form-input">

                    <input type="text"
                           name="client_phone"
                           value="{{ invoice['client_po'] }}"
                           placeholder="Client Purchase Order"
                           class="form-input">
                </div>

                <textarea name="client_address"
                          rows="3"
                          class="form-textarea"
                          placeholder="Client Full Address">{{ invoice['client_address'] }}</textarea>
            </div>
        </div>

        <!-- ========================== SECOND SECTION ========================== -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Section -->
            <div class="unique-card p-6 space-y-6 lg:col-span-2">

                <div>
                    <h2 class="text-xl font-semibold header-accent border-b pb-2">Select Department</h2>
                    <div class="flex flex-wrap gap-4 mt-4">
                        {% for dep in departments %}
                        <label class="flex items-center space-x-2 p-3 rounded-lg border border-gray-200 cursor-pointer bg-gray-50 hover:bg-teal-50">
                            <input type="radio" name="departments" value="{{ dep }}"
                                   {% if dep in invoice['departments'] %}checked{% endif %}>
                            <span class="text-sm font-medium">{{ dep }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-semibold header-accent border-b pb-2">Notes</h2>
                    <textarea name="notes" rows="3" class="form-textarea">{{ invoice['notes'] }}</textarea>
                </div>

                <div>
                    <h2 class="text-xl font-semibold header-accent border-b pb-2">Tax Selection</h2>
                    <div class="flex space-x-6 mt-3">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="taxes" value="cgst" {% if 'cgst' in invoice['taxes'] %}checked{% endif %}>
                            <span>CGST (9%)</span>
                        </label>

                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="taxes" value="sgst" {% if 'sgst' in invoice['taxes'] %}checked{% endif %}>
                            <span>SGST (9%)</span>
                        </label>
                    </div>
                </div>

            </div>

            <!-- Totals -->
            <div class="unique-card p-6 space-y-4">
                <h2 class="text-xl font-semibold header-accent border-b pb-2">Invoice Totals</h2>

                <label class="text-sm font-medium">Subtotal</label>
                <input type="text" id="subtotal" name="subtotal" value="{{ invoice['subtotal'] }}" readonly class="form-input text-right font-bold bg-gray-50">

                <label class="text-sm font-medium">GST Amount</label>
                <input type="text" id="gst_amount" name="gst_amount" value="{{ invoice['gst_amount'] }}" readonly class="form-input text-right font-bold bg-gray-50">

                <label class="text-sm font-medium">Final Total</label>
                <input type="text" id="final_total" name="final_total" value="{{ invoice['final_total'] }}" readonly class="form-input text-right font-extrabold text-2xl bg-primary-teal/10">
            </div>
        </div>

        <!-- ========================== ITEMS ========================== -->
        <div class="unique-card p-6">
            <h2 class="text-xl font-semibold header-accent border-b pb-4">Items / Services</h2>

            <div class="overflow-x-auto border rounded-lg mt-4">
                <table id="items_table" class="min-w-full">
                    <thead>
                        <tr>
                            <th class="table-header p-3 text-left text-white">Item/Service</th>
                            <th class="table-header p-3 text-center text-white">Qty</th>
                            <th class="table-header p-3 text-center text-white">Unit Price</th>
                            <th class="table-header p-3 text-center text-white">Total</th>
                            <th class="table-header p-3 text-center text-white">‚ùå</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for item in invoice['items'] %}
                        <tr>
                            <td class="p-3">
                                <input type="text" name="item_name[]" value="{{ item['item_name'] }}" placeholder="Item Name" class="form-input">
                            </td>

                            <td class="p-3">
                                <input type="number" name="quantity[]" value="{{ item['quantity'] }}" oninput="calculateTotals()" class="form-input">
                            </td>

                            <td class="p-3">
                                <input type="number" name="unit_price[]" value="{{ item['unit_price'] }}" oninput="calculateTotals()" class="form-input">
                            </td>

                            <td class="p-3">
                                <input type="text" name="total[]" value="{{ item['total'] }}" readonly class="form-input">
                            </td>

                            <td class="p-3 text-center">
                                <button type="button" onclick="removeRow(this)" class="text-red-600">‚ùå</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <button type="button" onclick="addItem()" class="btn-accent mt-4 py-2 px-4 rounded-lg shadow">
                ‚ûï Add Item
            </button>
        </div>

        <button type="submit"
                style="width:100%; padding:16px; background:#00695c; color:white;
                       border-radius:12px; font-size:22px; font-weight:700;
                       box-shadow:0 4px 12px rgba(0,0,0,0.2);">
            üíæ Update Invoice
        </button>

    </form>
</div>

<script>
function addItem() {
    let table = document.querySelector("#items_table tbody");
    let row = document.createElement("tr");

    row.innerHTML = `
        <td class="p-3"><input type="text" name="item_name[]" placeholder="Item Name" class="form-input"></td>
        <td class="p-3"><input type="number" name="quantity[]" value="1" oninput="calculateTotals()" class="form-input"></td>
        <td class="p-3"><input type="number" name="unit_price[]" value="0" oninput="calculateTotals()" class="form-input"></td>
        <td class="p-3"><input type="text" name="total[]" value="0" readonly class="form-input"></td>
        <td class="p-3 text-center"><button type="button" onclick="removeRow(this)" class="text-red-600">‚ùå</button></td>
    `;

    table.appendChild(row);
    calculateTotals();
}

function removeRow(btn) {
    btn.closest("tr").remove();
    calculateTotals();
}

function calculateTotals() {
    let subtotal = 0;

    document.querySelectorAll("#items_table tbody tr").forEach(row => {
        let qty = parseFloat(row.querySelector('[name="quantity[]"]').value) || 0;
        let price = parseFloat(row.querySelector('[name="unit_price[]"]').value) || 0;
        let total = qty * price;

        row.querySelector('[name="total[]"]').value = total.toFixed(2);
        subtotal += total;
    });

    let gst_rate = 0;

    if (document.querySelector('input[value="cgst"]')?.checked) gst_rate += 9;
    if (document.querySelector('input[value="sgst"]')?.checked) gst_rate += 9;

    let gst_amount = (subtotal * gst_rate) / 100;
    let final_total = subtotal + gst_amount;

    document.getElementById("subtotal").value = subtotal.toFixed(2);
    document.getElementById("gst_amount").value = gst_amount.toFixed(2);
    document.getElementById("final_total").value = final_total.toFixed(2);
}
</script>

</body>
</html>
